<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        :root {
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 5vh;
        }
        .center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* width: 75vw; */
            padding: 5ch;
            background-color: #b3b3b370;
        }
        #loginPrompt {
            /* display: flex;
            flex-direction: column; */
            position: absolute;
            z-index: 2;
            top: 25vh;
            right: 10%;
            bottom: auto;
            left: 10%;
            background-color: darkgray;
        }
        #loginForm {
            display: grid;
            grid-template-columns: repeat(2, minmax(7ch, 1fr)) repeat(2, 3fr) minmax(7ch, 2fr);
            grid-template-rows: repeat(3, minmax(2ch, auto)) minmax(2ch, 2fr) minmax(6ch, auto);
            column-gap: 1ch;
            row-gap: 1ch;
            grid-template-areas: 
            "ln ln in in ."
            "lp lp ip ip ."
            ". . . . ."
            "su su su cl cl"
            "ex ex ex ex ex"
            ;
            width: 100%;
        }
        form#loginForm > label {
            display: flex;
            justify-content: right;
            align-items: center;
            /* text-align: right; */
            padding: 1ch;
        }
        #loginNameLabel {
            grid-area: ln;
        }
        #loginPwdLabel {
            grid-area: lp;
        }
        form#loginForm > input {
            padding-left: 3ch;
        }
        #loginNameInput {
            grid-area: in;
        }
        #loginPwdInput {
            grid-area: ip;
        }
        #nameTab {
            position: absolute;
            padding: 1ch;
            color: white;
            font-weight: bold;
            background-color: #ff6f6f;
        }
        #pwdTab {
            position: absolute;
            padding: 1ch;
            color: white;
            font-weight: bold;
            background-color: #ff6f6f;
        }
        form#loginForm > button {
            padding: 2ch;
            font-size: 1.7ch;
            font-weight: bold;
            cursor: pointer;
        }
        #loginSubmitBtn {
            grid-area: su;
            border: .3ch solid black;
            border-radius: .5ch;
            background-color: rgb(105, 156, 105);
        }
        #loginSubmitBtn:hover {
            border-color: white;
            background-color: rgb(0, 160, 0);
        }
        #loginCancelBtn {
            grid-area: cl;
        }
        #loginCancelBtn:hover {
            border: darkgray;
            background-color: gray;
        }
        #loginExplaination {
            grid-area: ex;
            text-align: center;
        }
        #threadContainer {
            position: absolute;
            z-index: 1;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
        }
        /* ul#main-thread {
        } */
        li.thread {
            list-style-type: none;
        }
        /* li.thread > ul.threadList {
        } */
        ul.threadList > li.comment {
            list-style-type: none;
            word-wrap: break-word;
            width: 38ch;
        }
        /* li.comment > ul.newThread {
        } */
        li.comment > button { 
            margin-bottom: 1ch;
            padding: 1ch;
        }
        li.comment > div.commentBox {
            margin-bottom: 1ch;
            padding: 1ch;
            background-color: grey;
        }
        .hidden {
            display: none !important;/* Allows toggleing with shown-flex as default */
        }
        .greyed-out {
            background-color: black;
            opacity: .75;
        }
        .show-thread {
            background-color: green;
        }
        .hide-thread {
            background-color: grey;
        }
        .stop-scrolling {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>

    <header>
        <a href="/"><button id="homeBtn">Home</button></a>
        <button id="loginBtn">Login</button>
        <a href="/signup"><button>Sign-up</button></a>
    </header>

    <div id="loginPrompt" class="hidden">
        <div class="center">
            <form id="loginForm" action="/login" method="POST">
                <label id="loginNameLabel" for="name">Name:</label>
                <input id="loginNameInput" type="text" name="name" required placeholder="display name"/>
                    <div><span id="nameTab" class="hidden">Incorrect Name</span></div>
                <label id="loginPwdLabel" for="pwd">Password:</label>
                <input id="loginPwdInput" type="password" name="pwd" required placeholder="********"/>
                    <div><span id="pwdTab" class="hidden">Incorrect Password</span></div>
                <!-- Prevent implicit submission of the form -->
                <button type="submit" disabled style="display: none" aria-hidden="true"></button>
                <!-- Use this submit button because it allows for redirecting and method passing beyond a  required redirect. Different statuses could be used to show alternate information, and loading progress can be displayed which may otherwise look like an error if the page doesnt load from a form submission. -->
                <button id="loginSubmitBtn" type="button" >Submit</button>
                <button id="loginCancelBtn" type="button" >Cancel</button>
                <p id="loginExplaination">If you need a login please follow this link: <a href="/signup">Sign-up page</a>.</p>
            </form>
        </div>
    </div>

    <div id="threadContainer" class="hidden"></div>

    <div class="container">
        <div class="center">
            <h1>COMMENT-STACK-MESSAGE-BOARD</h1>
        </div>
    </div>

    <div>
        <ul id="main-thread">#REPLACE-W-COMMENTS#</ul> <!-- main-thread -->
    </div>

    <script>

        function isInputValueCorrect(elementVal) {
            if( elementVal.length >= 3 && elementVal.length <= 15 ) {
                return true;
            }
            return false;
        }

        function setCorrectInputFields() {
            document.getElementById('nameTab').classList.add( 'hidden' );
            document.getElementById('pwdTab').classList.add( 'hidden' );
        }

        function setIncorrectInputFields( ...elements) {
            for(let ele of elements) {
                ele.style.backgroundColor = "#ff6f6f";
                ele.nextElementSibling.firstChild.classList.remove( 'hidden' );
            }
        }

        function disableScroll() {
            document.body.classList.add("stop-scrolling");
        }
        
        function enableScroll() {
            document.body.classList.remove("stop-scrolling");
        }

        ( function applyLoginBtnOnClick() {
            let loginBtn = document.getElementById("loginBtn");
            let loginPrompt = document.getElementById("loginPrompt");
            let threadContainer = document.getElementById("threadContainer");

                loginBtn.onclick = () => {
                    loginPrompt.classList.toggle("hidden");
                    threadContainer.classList.toggle("greyed-out");
                    threadContainer.classList.toggle("hidden");
                    disableScroll();
                };
        })();

        ( function assignInputOnUpdate() {

            for(let input of document.getElementsByTagName('input')) {

                input.addEventListener( "focusin", () => {
                    input.style.backgroundColor = '';
                } );

                input.addEventListener( "focusout", () => {
                    if( isInputValueCorrect(input.value) ) {
                        input.style.backgroundColor = '#59a659'; // Green
                    } else {
                        input.style.backgroundColor = '#ff6f6f'; // Red
                    }
                    setCorrectInputFields();
                } );

                input.addEventListener( "input", () => {
                    if( isInputValueCorrect(input.value) ) {
                        input.style.backgroundColor = '#59a659';
                    } else {
                        input.style.backgroundColor = '#ff6f6f';
                    }
                } );
            }
        })();

        ( function applyLoginCancelBtnOnClick() {
            let nameInput = document.getElementById("loginNameInput");
            let pwdInput = document.getElementById("loginPwdInput");

            let loginCancelBtn = document.getElementById('loginCancelBtn');
                loginCancelBtn.onclick = () => {
                    let loginPrompt = document.getElementById("loginPrompt");
                        loginPrompt.classList.toggle("hidden");

                    setCorrectInputFields();

                    nameInput.value = '';
                    nameInput.style.backgroundColor = '';
                    pwdInput.value = '';
                    pwdInput.style.backgroundColor = '';

                    threadContainer.classList.toggle("greyed-out");
                    threadContainer.classList.toggle("hidden");

                    enableScroll();
                }
        })();
        
        ( function applyLoginSubmitBtnOnClick() {

            let loginSubmitBtn = document.getElementById("loginSubmitBtn");
                loginSubmitBtn.onclick = () => {
                    /* * Conver Into JSON Object Method*/
                    // ! This method is commonly over 6bytes = BEST
                    var loginObj = new Object();

                    let nameInput = document.getElementById("loginNameInput");
                    let pwdInput = document.getElementById("loginPwdInput");

                    if( !isInputValueCorrect( nameInput.value ) ) {
                        setIncorrectInputFields(nameInput);
                        return ;
                    }
                    loginObj.name = nameInput.value;

                    if( !isInputValueCorrect( pwdInput.value ) ) {
                        setIncorrectInputFields(pwdInput);
                        return ;
                    }
                    loginObj.pwd = pwdInput.value;

                    let logR = new XMLHttpRequest();
                    logR.responseType = 'text/plain';
                    logR.open('POST', "/login");
                    logR.setRequestHeader("Content-Type", "application/json");

                    /* * Use String with encType - application/x-www-form-urlencoded */
                    // ! This method is is commonly over 20 bytes.
                    // let name = document.getElementById("loginNameInput").value;
                    // let pwd = document.getElementById("loginPwdInput").value;
                    // let formInfo = `name=${name}&pwd=${pwd}`;

                    // let logR = new XMLHttpRequest();
                    // logR.responseType = 'text/html';
                    // logR.open('POST', "/login");
                    // logR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

                    logR.onload = function (e) {

                        // * If Recieve OK - Proceed to home page.
                        if (this.status >= 200 && this.status <= 299) {
                            if(Boolean(this.getResponseHeader('Location'))) {
                                window.location.assign(this.getResponseHeader('Location'));
                            } else {
                                window.location.assign('/');
                            }
                            return ;
                        }

                        /* if (this.status >= 300 && this.status <= 399) {
                            // ! Unable to Control redirects with XHR
                        } */

                        if(this.status >= 400 && this.status <= 499) {
                            setIncorrectInputFields( 
                                nameInput,
                                pwdInput
                            );
                            return ;
                        }

                        if(this.status >= 500 && this.status <= 599) {
                            alert('Please Notice! \nCOMMENT-STACK-MESSEGE-BOARD is currently undergoing maintenance.. \nPlease be patient, and checkback later. \n\nThank You.');
                            window.location.assign('/');
                        }
                        return ;
                    };
                    logR.send(JSON.stringify(loginObj));
                };
        })();
    </script>

    <script>

        function revealCollapsableThreads() {
            let collapsableThreads = document.getElementsByClassName('newThread');

            for(let i=0; i < collapsableThreads.length; i++) {

                if(collapsableThreads[i].childElementCount > 0) {
                    collapsableThreads[i].classList.toggle('hidden');
                }
            }
        }

        function applyThreadCollapseBtnOnclick() {
            let threadCollapseBtns = document.getElementsByClassName('threadCollapseBtn');

            for(let i=0; i < threadCollapseBtns.length; i++) {

                let newThread = threadCollapseBtns[i].parentElement.getElementsByClassName('newThread')[0];

                if(newThread?.children.length > 0) {
                    threadCollapseBtns[i].classList.toggle('hidden');
                    threadCollapseBtns[i].onclick = function () {
                        newThread.classList.toggle('hidden');

                        if(newThread.classList.contains('hidden')) {
                            this.innerHTML = 'Show Comments';
                            this.classList.add('show-thread');
                            this.classList.remove('hide-thread');
                        } else {
                            this.innerHTML = 'Hide Comments';
                            this.classList.add('hide-thread');
                            this.classList.remove('show-thread');
                        }
                    }
                }
            }
        }

        function checkVisibleThreads() {

            function isEleOnScreen(element) {
                let box = element.getBoundingClientRect();
                if( (box.x + box.width) > window.innerWidth || box.x > window.innerWidth) {
                    return false;
                }
                return true;
            }

            let comments = document.getElementsByClassName('comment');
            for(let liComment of comments) {

                if(liComment.classList.contains('hidden')) { continue ; }

                if( isEleOnScreen(liComment) ) {
                    let newThreadComment = liComment.children[3]?.children[0]?.children[0]?.children[0];
                    if(newThreadComment) {
                        if( !isEleOnScreen(newThreadComment) ){
                            let threadCollapseBtn = liComment.children[2];
                                threadCollapseBtn.click();
                        }
                    }
                } else {
                    let threadCollapseBtn = liComment.children[2];
                        threadCollapseBtn.click();
                }       
            }
        }

        function handleElements() {
            revealCollapsableThreads();
            applyThreadCollapseBtnOnclick();
            checkVisibleThreads();
        }

        var observer = new MutationObserver( (mut, obsInstance) => {
            var eofEle = document.getElementById('EOF');
            if (eofEle) {
                obsInstance.disconnect();
                handleElements();
                return;
            }
        });

        observer.observe(document, {
            childList: true,
            subtree: true
        });
    </script>
    
</body>
</html>